<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Gita - {{ tv_symbol }} Analysis</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #131722;
            color: #d1d4dc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
        }

        #chart-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #legend {
            position: absolute;
            left: 12px;
            top: 12px;
            z-index: 1;
            font-size: 14px;
            line-height: 18px;
            font-weight: 300;
        }

        .legend-symbol {
            font-size: 24px;
            font-weight: bold;
        }

        .legend-price {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <div id="chart-container"></div>
    <div id="legend">
        <div class="legend-symbol">{{ tv_symbol }}</div>
        <div class="legend-price" style="font-size: 16px; opacity: 0.7;">â€”</div>
    </div>

    <script>
        const chartData = {{ data_json | safe }};
        const zones = {{ zones_json | safe }};
        
        if (!chartData || chartData.length === 0) {
             document.getElementById('chart-container').innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#ef5350;">No Data Available</div>';
             throw new Error("No chart data");
        }

        const chartOptions = {
            layout: {
                textColor: '#d1d4dc',
                background: { type: 'solid', color: '#131722' }
            },
            grid: {
                vertLines: { color: '#2B2B43' },
                horzLines: { color: '#2B2B43' }
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
            },
            timeScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
            },
        };

        const container = document.getElementById('chart-container');
        const chart = LightweightCharts.createChart(container, chartOptions);

        const candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350'
        });

        candlestickSeries.setData(chartData);

        // Fit Content
        chart.timeScale().fitContent();

        // Add Zones (Support/Resistance Lines)
        // zones.support and zones.resistance are arrays of prices

        if (zones.support) {
            zones.support.forEach(price => {
                candlestickSeries.createPriceLine({
                    price: price,
                    color: '#00E676', // Green
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: 'SUPPORT',
                });
            });
        }

        if (zones.resistance) {
            zones.resistance.forEach(price => {
                candlestickSeries.createPriceLine({
                    price: price,
                    color: '#FF5252', // Red
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: 'RESISTANCE',
                });
            });
        }

        // Window Resize Handler
        window.addEventListener('resize', () => {
            chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
        });

        // Legend Update
        chart.subscribeCrosshairMove((param) => {
            const legendPrice = document.querySelector('.legend-price');
            if (param.time) {
                const data = param.seriesData.get(candlestickSeries);
                if (data) {
                    const close = data.close.toFixed(2);
                    const diff = (data.close - data.open).toFixed(2);
                    const color = diff >= 0 ? '#26a69a' : '#ef5350';
                    legendPrice.innerHTML = `<span style="color: ${color}">$${close}</span>`;
                }
            }
        });
    </script>
</body>

</html>